---
title: "05 - Meta-analysis"
author: "Stefano Coretta"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = here::here())
library(tidyverse)
library(brms)
library(tidybayes)
library(faux)
library(betapart)
library(modelr)
my_seed <- 99
set.seed(my_seed)
b4ss_colors <- c(purple = "#8970FF", orange = "#FFA70B")

```

# Read data

```{r}
msa_models <- readRDS("./data/analyses/msa_models.rds") %>%
  mutate(
    outcome = as.factor(outcome),
    typicality = as.factor(typicality),
    temporal_window = as.factor(temporal_window)
  ) %>%
  droplevels() %>%
  mutate(
    outcome = contr_code_sum(outcome),
    typicality = contr_code_sum(typicality),
    temporal_window = contr_code_sum(temporal_window)
  )

# bpair <- tibble::tibble(preds) %>% tidyr::unnest_wider(preds, names_sep = ".") %>%
#     as.matrix() %>%
#     betapart::beta.pair(.)
#   sdim <- as.matrix(bpair$beta.sor)
#   diag(sdim) <- NA
#   rowSums(sdim, na.rm = T) / length(preds)
```

# Meta-analysis

```{r}
priors <- c(
  prior(normal(0, 1), class = Intercept),
  prior(cauchy(0, 1), class = sd)
)

meta_bm <- brm(
  estimate | se(se) ~ (1 | model_id),
  data = msa_models,
  prior = priors,
  chain = 4,
  seed = my_seed,
  cores = 4,
  backend = "cmdstanr",
  threads = threading(2),
  file = "./data/meta_analysis/meta_bm.rds"
)
```

```{r}
meta_bm
```

```{r}

# wrangle by hand 
post_meta <- meta_bm %>%
  spread_draws(b_Intercept, r_model_id[model,]) %>%
  mutate(model_mean = b_Intercept + r_model_id) %>% 
  group_by(model) %>% 
  dplyr::summarise(post_mean = mean(model_mean),
            lower95 = quantile(model_mean, probs = .025),
            higher95 = quantile(model_mean, probs = .975)
            ) %>% 
  # this basically needs to be fed by whether or not the authors considered there to be an effect
  mutate(compelling = as.factor(case_when(lower95 > 0 ~ "negative",
                                          higher95 < 0 ~ "positive",
                                          TRUE ~ "not compelling"))) 
  
# extract model mean and CrIs
population_mean = fixef(meta_bm)[1,1]
population_lower95 = fixef(meta_bm)[1,3]
population_higher95 = fixef(meta_bm)[1,4]

meta_plot1 <- 
ggplot(post_meta,
       aes(x = reorder(model, post_mean), 
             y = post_mean, 
             colour = compelling)) +
  geom_hline(yintercept = 0,
             lty = "dotted") +
  geom_point(size = 0.5) +
  geom_errorbar(aes(ymin = lower95,
                    ymax = higher95),
                 width = 0) +
  scale_y_continuous(limits = c(-0.5, 1),
                     breaks = c(-0.5, 0, 0.5, 1)) + 
  annotate("text",
           x = c(30, 90, 150),
           y = 0.8,
           hjust = c(0, 0.5, 1),
           color = c(b4ss_colors[[2]], "black", b4ss_colors[[1]]),
           label = c("Negative (95% CrI)",
                     "Not compelling",
                     "Positive (95% CrI)")
           ) +
  labs(x = "submitted statistical models",
       y = "standardized posterior effect size") +
  scale_color_manual(values = c(b4ss_colors[[1]], "black", b4ss_colors[[2]])) + 
  theme_classic() +
  theme(legend.position = "none",
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.line = element_blank()
        )

ggsave(filename = "./plots/meta_plot1.png",
       plot = meta_plot1,
       device = "png",
       width = 200, 
       height = 75,
       units = "mm", 
       dpi = 500)

```

# Analytic and researcher-related predictors model

Weakly-informative regularising priors.

```{r preds-priors}
preds_priors <- c(
  prior(normal(0, 1), class = Intercept),
  prior(normal(0, 1), class = b)
  # prior(normal(0, 1), class = meanme),
  # prior(cauchy(0, 1), class = sdme),
  # prior(lkj(2), class = corme)
)
```

```{r predictors-bm}
predictors_bm <- brm(
  estimate | se(se) ~
    # pop_sdi +
    # phoc_n +
    n_models +
    outcome +                  # major dimension
    temporal_window +          # temporal window
    typicality +
    all_rating +
    years_from_phd +
    prior_belief,
  data = msa_models,
  prior = preds_priors,
  chain = 4,
  iter = 4000,
  # control = list(adapt_delta = 0.9999, max_treedepth = 15),
  seed = my_seed,
  cores = 4,
  threads = threading(2),
  backend = "cmdstanr",
  file = "./data/meta_analysis/predictors_bm.rds"
)
```

```{r}
predictors_bm
```

```{r}
plot(conditional_effects(predictors_bm), ask = FALSE)
```


---
title: "Sample size"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = here::here())
library(tidyverse)
theme_set(theme_light())
library(brms)
library(extraDistr)
library(HDInterval)
library(tidybayes)
```

```{r dirs}
# Create dirs to save files to if they don't exist
dir.create("./models/sims", FALSE, TRUE)
dir.create("./figs/sample-size", FALSE)
```


```{r Silberzahn}
# load in Silberzahn et al. data: https://osf.io/fa743/
silber <- read_csv("https://osf.io/fa743/download") %>%
  mutate(
    z_score = log(OR) / ((log(OR) - log(OR_lo)) / 1.96)
  ) %>%
  filter(z_score < 6)

## run model on OR to estimate between teams SD

# set weakly informative priors
# mean OR
round(mean(silber$z_score), 2)

priors <- c(
  prior(normal(0, 1), class = Intercept),
  prior(cauchy(0, 1), class = sd)
)

# run simple model
silber_sd <- brm(
  z_score ~ (1 | Team),
  data = silber,
  prior = priors,
  chain = 4,
  iter = 4000,
  cores = 4,
  backend = "cmdstanr", threads = threading(4),
  control = list(adapt_delta = 0.99999, max_treedepth = 15),
  file = "./models/sims/silber_sd"
)

# extract SD estimate and 95 CrI
SD <- summary(silber_sd)$random[[1]][1]
lower <- summary(silber_sd)$random[[1]][3]
upper <- summary(silber_sd)$random[[1]][4]

quantiles <- quantile(seq(lower, upper, by = 0.1), probs = seq(0, 1, 0.25),  na.rm = FALSE)
quantiles <- c(quantiles[[1]], quantiles[[2]], quantiles[[3]], quantiles[[4]], quantiles[[5]])
n_teams <- seq(15, 40, by = 5)

# Get all unique combos of number of teams and quantiles of SD.
n_ts_qs <- expand_grid(n_teams, quantiles)
```

```{r functions}
simulate_data <- function(n, sd) {
  tibble::tibble(
    z_score = rnorm(n, 0, sd),
    # no measurement error model for the simulation
    # es_se = rhcauchy(n, 0.15),
    team = letters[1:n]
  )
}

run_brm <- function(data) {
  priors <- c(
    brms::prior(normal(0, 1), class = Intercept),
    brms::prior(cauchy(0, 1), class = sd)
  )
  
  meta_bm <- brms::brm(
    z_score ~
      (1 | team),
    data = data,
    prior = priors,
    chain = 4,
    iter = 6000,
    cores = 4,
    backend = "cmdstanr", threads = brms::threading(4),
    control = list(adapt_delta = 0.9999, max_treedepth = 15),
  )
  
  return(meta_bm)
}

run_simulations <- function(n, sd) {
  data <- simulate_data(n, sd)
  
  cat("Model:", n, sd, "\n")
  brm_model <- run_brm(data)
  
  sd_team <- summary(brm_model)
  
  return(sd_team)
}
```


```{r run-sims}
sample_file <- "./models/sims/sample_sims.rds"

if (file.exists(sample_file)) {
  sample_sims <- readRDS(sample_file)
} else {
  sample_sims <- tibble(
    n_teams = n_ts_qs$n_teams,
    quants = n_ts_qs$quantiles,
    sd_team = map2(
      n_teams, quants,
      ~run_simulations(.x, .y)
    )
  )
  
  saveRDS(sample_sims, sample_file)
}
```

```{r plot, eval=FALSE, include=FALSE}
sample_sims <- sample_sims %>%
  mutate(
    cri = map(sd_team, function(.x) .x$random$team[4] - .x$random$team[3]) %>% unlist()
  )

sample_sims %>%
  ggplot(aes(quants, cri, colour = as.factor(n_teams))) +
  geom_line() +
  geom_point(size = 4) +
  geom_hline(yintercept = 1) +
  geom_hline(yintercept = 2, linetype = "dashed") +
  scale_x_continuous(breaks = quantiles) +
  scale_color_brewer(type = "seq", palette = "BuPu") +
  labs(
    title = "95% CrI width depending on teams' true SD and number of teams",
    x = "Teams' true standard deviation",
    y = "95% CrI width",
    colour = "N of teams"
  )

ggsave("./figs/sample-size/cri-width-nteams-true-sd.pdf", width = 7, height = 5)
```


---
title: "OSF management"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = here::here())
library(here)
library(tidyverse)
library(osfr)
library(speakr)
```

# Manage OSF with osfr

This document contains the code used to manage the OSF repo with the [osfr](https://docs.ropensci.org/osfr/) package.

# Retrieve OSF Data component

```{r retrieve}
# Main repo "Many Speech Analysis": https://osf.io/3bmcp/
osf_data <- osf_retrieve_node("5agn9")
```

# Prepare files

## Readme files

We can knit the readme files (they are GitHub documents, i.e. `.Rmd` files that are converted to `.md` files upon knitting).

```{r knit-readmes, message=FALSE, warning=FALSE}
readme_rmds <- list.files("./osf/data", pattern = "[.]Rmd$", recursive = T, full.names = T)

for (f in readme_rmds) {
  xfun::Rscript_call(rmarkdown::render, list(f))
}
```

## Norming study

```{r ratings}
ratings <- read_csv("./data/dataset/ratings.csv") %>%
  mutate(
    # Fix wrong encoding
    object = str_replace(object, "W�_scheklammer", "Waescheklammer"),
    object = str_replace(object, "M̦hre", "Moehre"),
  ) %>%
  rename(prolific_id = `prolific id`) %>%
  select(prolific_id, object, colour, typicality) %>%
  arrange(prolific_id, object, colour) %>%
  mutate(
    object_en = case_when(
      object == "Ananas" ~ "pineapple",
      object == "Aprikose" ~ "apricot",
      object == "Aubergine" ~ "aubergine",
      object == "Avocado" ~ "avocado",
      object == "Banane" ~ "banana",
      object == "Birne" ~ "pear",
      object == "Bohnen" ~ "beans",
      object == "Bueroklammer" ~ "paper.clip",
      object == "Erbsen" ~ "peas",
      object == "Erdbeere" ~ "strawberry",
      object == "Gurke" ~ "cucumber",
      object == "Kartoffeln" ~ "potatoes",
      object == "Kirsche" ~ "cherry",
      object == "Mandarine" ~ "mandarine",
      object == "Moehre" ~ "carrots",
      object == "Paprika" ~ "pepper",
      object == "Socken" ~ "socks",
      object == "Sonnenbrille" ~ "suglasses",
      object == "Tomate" ~ "tomato",
      object == "Trauben" ~ "grapes",
      object == "Waescheklammer" ~ "clothes.peg",
      object == "Walnuss" ~ "walnut",
      object == "Zitrone" ~ "lemon",
      object == "Zucchini" ~ "courgettes"
    ),
    colour_en = case_when(
      colour == "blau" ~ "blue",
      colour == "braun" ~ "brown",
      colour == "gelb" ~ "yellow",
      colour == "grau" ~ "gray",
      colour == "gruen" ~ "green",
      colour == "lila" ~ "lilac",
      colour == "orange" ~ "orange",
      colour == "rot" ~ "red",
      colour == "schwarz" ~ "black"
    )
  )

write_csv(ratings, "./osf/data/norming/ratings/ratings.csv")

ratings_summary <- ratings %>%
  group_by(object, colour, object_en, colour_en) %>%
  summarise(
    typ_mean = mean(typicality),
    typ_sd = sd(typicality),
    typ_median = median(typicality),
    .groups = "drop"
  )

write_csv(ratings_summary, "./osf/data/norming/ratings/ratings_summary.csv")
```

## Production study

```{r textgrids}
praat_run("./scripts/praat/prep_textgrids.praat")
```

```{r tlists}
tlists <- list.files("./data/trial-lists", ".csv", full.names = TRUE)
typ <- read_csv("./data/dataset/typicality.csv")

for (tlist in tlists) {
  speaker <- str_sub(tlist, 20, 23) %>%
    str_remove("\\.c")
  tbl <- read_csv(tlist) %>%
    mutate(
      speaker = speaker,
      trial = row_number()
    ) %>%
    left_join(y = typ) %>%
    select(speaker, trial, condition, typicality, everything()) %>%
    mutate(typicality = ifelse(condition == "NF", typicality, NA)) %>%
    left_join(y = ratings_summary, by = c("target_name" = "object", "target_colour" = "colour"))
  
  write_csv(tbl, file = paste0("./osf/data/production/trial-lists/", speaker, ".csv"))
}
```

# Upload files

```{r upload-files, eval=FALSE}
osf_upload(osf_data, path = "./osf/data/norming", recurse = T, verbose = T)
osf_upload(osf_data, path = "./osf/data/production", recurse = T, verbose = T)
osf_upload(osf_data, path = "./osf/data/README.md", recurse = T, verbose = T)
osf_upload(osf_data, path = "./osf/data/methods_norm_prod.pdf", recurse = T, verbose = T)
```

